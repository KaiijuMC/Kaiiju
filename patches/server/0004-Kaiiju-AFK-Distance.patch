From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Kugge <sofiane.djerbi38@gmail.com>
Date: Sun, 15 Jan 2023 21:42:02 +0100
Subject: [PATCH] Kaiiju AFK Distance


diff --git a/src/main/java/dev/kugge/kaiiju/KaiijuConfig.java b/src/main/java/dev/kugge/kaiiju/KaiijuConfig.java
index 45df8d6569e0d3ca5ceec6cd4de59caeb967e69c..84a782ddfca2e69438cc132d9f81a6a6a178f319 100644
--- a/src/main/java/dev/kugge/kaiiju/KaiijuConfig.java
+++ b/src/main/java/dev/kugge/kaiiju/KaiijuConfig.java
@@ -133,4 +133,23 @@ public class KaiijuConfig {
         return config.getStringList(key);
     }
 
-}
\ No newline at end of file
+    public static boolean useIdleDistances;
+    private static void getUseIdleDistances() {
+        useIdleDistances = getBoolean("distances.use-afk-distances", false,
+                                      "Whether or not AFK distances should be enabled.",
+                                      "Require \"kick-if-idle: false\" in Purpur config.");
+    }
+
+    public static int idleViewDistance;
+    private static void getIdleViewDistance() {
+        idleViewDistance = getInt("distances.afk-view-distance", 9,
+                                  "View distance for AFK players.");
+    }
+
+    public static int idleSimulationDistance;
+    private static void getIdleSimulationDistance() {
+        idleSimulationDistance = getInt("distances.afk-simulation-distance", 8,
+                                        "Simulation distance for AFK players.");
+    }
+
+}
diff --git a/src/main/java/net/minecraft/server/level/ServerPlayer.java b/src/main/java/net/minecraft/server/level/ServerPlayer.java
index d62bf95fb067c2e2a4fc9b2757c636bd4ee75bea..a816a97cdbf85c8944ba03757048f0e0f63a0c99 100644
--- a/src/main/java/net/minecraft/server/level/ServerPlayer.java
+++ b/src/main/java/net/minecraft/server/level/ServerPlayer.java
@@ -2084,6 +2084,15 @@ public class ServerPlayer extends Player {
     public void resetLastActionTime() {
         this.lastActionTime = Util.getMillis();
         this.setAfk(false); // Purpur
+        // Kaiiju start
+        if (dev.kugge.kaiiju.KaiijuConfig.useIdleDistances) {
+            try {
+                this.getBukkitEntity().setViewDistance(this.getBukkitEntity().getWorld().getViewDistance());
+                this.getBukkitEntity().setSimulationDistance(this.getBukkitEntity().getWorld().getSimulationDistance());
+            }
+            catch (IllegalStateException e) {} // End portal. Skip
+        }
+        // Kaiiju end
     }
 
     // Purpur Start
diff --git a/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java b/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
index a8e205af936efe0909c94575e3b7f8ca50cead2f..1963ec2be425002b93542d4f1d24e9c4adb8ded1 100644
--- a/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
+++ b/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
@@ -461,6 +461,15 @@ public class ServerGamePacketListenerImpl implements ServerPlayerConnection, Tic
             // Purpur start
             this.player.setAfk(true);
             if (!this.player.level.purpurConfig.idleTimeoutKick || kickPermissionCache.getUnchecked(this.player.getBukkitEntity())) {
+                // Kaiiju start
+                if (dev.kugge.kaiiju.KaiijuConfig.useIdleDistances) {
+                    try {
+                        this.getCraftPlayer().setViewDistance(dev.kugge.kaiiju.KaiijuConfig.idleViewDistance);
+                        this.getCraftPlayer().setSimulationDistance(dev.kugge.kaiiju.KaiijuConfig.idleSimulationDistance);
+                    }
+                    catch (IllegalStateException e) {} // End portal. Skip
+                }
+                // Kaiiju end
                 return;
             }
             // Purpur end
